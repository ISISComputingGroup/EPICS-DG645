record(calc, "$(P)$(R)SUMMED_DLAY")
{
    field(INPA, "$(P)$(R)$(chan1=A)DELAY:RB CP MS")
    field(INPB, "$(P)$(R)$(chan2=C)DELAY:RB CP MS")
    field(CALC, "A+B")
    field(EGU, "us")
}

record(ai, "$(P)$(R)OFFSET")
{
    field(VAL, "0")
    field(EGU, "us")
}

record(ai, "$(P)$(R)DELAY")
{
    field(VAL, "0")
    field(EGU, "us")
}

record(calc, "$(P)$(R)SUMMED_VALUE")
{
    field(INPA, "$(P)$(R)DELAY CP")
    field(INPB, "$(P)$(R)OFFSET CP")
    field(CALC, "A+B")
    field(EGU, "us")
}

record(calc, "$(P)$(R)_MODE1CHECK")
{
    field(INPA, "$(P)$(R)$(chan2=C)DELAY:RB CP")
    field(INPB, "$(P)$(R)SUMMED_VALUE CP")
    field(CALC, "(A+B)>39900||B<0")
}

record(calc, "$(P)$(R)_MODE2CHECK")
{
    field(INPA, "$(P)$(R)$(chan2=C)DELAY:RB CP")
    field(INPB, "$(P)$(R)SUMMED_VALUE CP")
    field(CALC, "B>39900||(A+B)<=0")
}

record(calc, "$(P)$(R)_BOTHCHECKS")
{
    field(INPA, "$(P)$(R)SAVE_STATE CP")
    field(INPB, "$(P)$(R)_MODE1CHECK CP")
    field(INPC, "$(P)$(R)_MODE2CHECK CP")
    field(CALC, "(A=1)?B:C")
}

record(calcout, "$(P)$(R)ERROR")
{
    field(INPA, "$(P)$(R)SAVE_STATE CP")
    field(INPB, "$(P)$(R)_BOTHCHECKS")
    field(CALC, "A=0||B")
    field(OOPT, "When Zero")
    field(OUT, "$(P)$(R)WRITE_DELAY PP")
    field(DOPT, "Use OCAL")
    field(OCAL, "1")
}

record(seq, "$(P)$(R)WRITE_DELAY")
{
    field(VAL, "0")

    # 1) display set
    # 2) units set
    field(LNK2, "$(P)$(R)$(chan1=A)DELAYUNIT:SP")
    field(DO2, "2")
    # 3) set t0
    field(LNK3, "$(P)$(R)$(chan1=A)REFERENCE:SP")
    field(DO3, "T0")
    # 4) set dlay A
    field(LNK4, "$(P)$(R)$(chan1=A)DELAY:SP")
    field(DOL4, "$(P)$(R)SUMMED_VALUE")
    # 5) send
    field(LNK5, "$(P)$(R)$(chan1=A)DELAYBUTTON")
    field(DO5, "1")
    # 6) *CLS StatusClearBO
    field(LNK6, "$(P)$(R)StatusClearBO")
    field(DO6, "1")
    
    field(SELM, "All")
}
